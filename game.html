<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Game Cinta üéÆüíó</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    /* FULLSCREEN GAME */
    body{ margin:0; overflow:hidden; background:#000; }
    .fs{
      position:fixed; inset:0;
      display:grid;
      grid-template-rows:auto 1fr;
      z-index: 5;
    }
    .hudTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(12px);
      color:#fff;
    }
    .hudLeft{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .hudRight{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.15);
      font-weight:800;
      white-space:nowrap;
    }
    .badge .p1{ color:#fff; }
    .badge .p2{ color:#ff4d88; }
    .btnMini{
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.12);
      color:#fff; font-weight:800;
      cursor:pointer;
    }
    .btnMini:hover{ background: rgba(255,255,255,.18); }

    #stage{ position:relative; }
    canvas{
      width:100vw; height:calc(100vh - 56px);
      display:block;
      background:#000;
    }
    video{ display:none; }

    /* overlay status */
    .overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at center, rgba(255,0,90,.18), rgba(0,0,0,.6));
      color:#fff;
      text-align:center;
      padding:18px;
    }
    .panel{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      padding:18px;
      backdrop-filter: blur(12px);
    }
    .panel h2{ margin:0 0 8px; font-family: 'Playfair Display', serif; }
    .panel p{ margin:6px 0; color: rgba(255,255,255,.86); }
    .panel .row{ margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .panel input{
      width:140px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.25);
      color:#fff;
      outline:none;
    }
    .panel input:focus{ border-color: rgba(255,77,136,.7); box-shadow:0 0 0 4px rgba(255,77,136,.18); }

    .toast2{
      position:fixed; left:50%; bottom:16px;
      transform:translateX(-50%);
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      padding:10px 14px;
      border-radius:16px;
      backdrop-filter: blur(10px);
      font-weight:800;
      z-index:9999;
    }
  </style>
</head>

<body>
  <div class="fs">
    <div class="hudTop">
      <div class="hudLeft">
        <span class="badge">üéÆ <b>Game Cinta</b></span>
        <span class="badge">P1: <span id="s1">0</span> <span class="p1">(Putih)</span></span>
        <span class="badge">P2: <span id="s2">0</span> <span class="p2">(Merah)</span></span>
        <span class="badge">üéØ Target: <span id="tLabel">10</span></span>
      </div>

      <div class="hudRight">
        <button id="exit" class="btnMini">‚óÄ Kembali</button>
        <button id="reset" class="btnMini">Reset</button>
      </div>
    </div>

    <div id="stage">
      <video id="video" playsinline></video>
      <canvas id="c"></canvas>

      <div id="overlay" class="overlay">
        <div class="panel">
          <h2>Siap main berdua? üíó</h2>
          <p>1) Klik Start dan izinkan kamera</p>
          <p>2) Berdiri berdua: kiri = Player 1, kanan = Player 2</p>
          <p>3) Tangkap bola sesuai warna pakai tangan ‚úã</p>

          <div class="row">
            <label style="display:flex;gap:8px;align-items:center;">
              Target
              <input id="target" type="number" min="3" max="200" value="10"/>
            </label>
            <button id="start" class="btnMini">Start</button>
          </div>

          <p style="margin-top:10px; opacity:.9;">
            Game mulai otomatis setelah <b>2 wajah terdeteksi</b>.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <script>
    // ========= helpers =========
    const $ = (id)=>document.getElementById(id);
    const s1El=$("s1"), s2El=$("s2"), tLabel=$("tLabel");
    const overlay=$("overlay"), video=$("video"), canvas=$("c");
    const ctx=canvas.getContext("2d");

    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
    function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.sqrt(dx*dx+dy*dy); }

    function toast2(msg){
      const t=document.createElement("div");
      t.className="toast2";
      t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 900);
    }

    // ========= sizing =========
    function resize(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight - 56; // hudTop height approx
    }
    window.addEventListener("resize", resize);
    resize();

    // ========= game state =========
    let running=false;
    let score1=0, score2=0;
    let target=10;

    // face centers (left/right)
    const faceL = {x:0,y:0,seen:false};
    const faceR = {x:0,y:0,seen:false};

    // hands points: index fingertip
    const h1 = {x:0,y:0,seen:false};
    const h2 = {x:0,y:0,seen:false};

    // balls
    const balls=[];
    const BALL_N = 10;

    function spawnBall(owner){
      const r = 16 + Math.random()*10;
      const x = r + Math.random()*(canvas.width - r*2);
      const y = r + 40 + Math.random()*(canvas.height - r*2 - 60);
      const vx = (Math.random()*2-1)*(2.2 + Math.random()*1.2);
      const vy = (Math.random()*2-1)*(2.2 + Math.random()*1.2);
      return {owner, x, y, vx, vy, r};
    }

    function resetGame(){
      running=false;
      score1=0; score2=0;
      s1El.textContent="0";
      s2El.textContent="0";
      balls.length=0;
      for(let i=0;i<BALL_N;i++){
        balls.push(spawnBall(i%2===0?1:2));
      }
      overlay.style.display="flex";
    }

    function beginRunning(){
      running=true;
      overlay.style.display="none";
    }

    // ========= MediaPipe FaceDetection =========
    const fd = new FaceDetection({
      locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${f}`
    });
    fd.setOptions({ model:"short", minDetectionConfidence:0.6 });
    fd.onResults((res)=>{
      faceL.seen=false; faceR.seen=false;
      const dets = (res.detections||[]).slice(0,2);
      if (!dets.length) return;

      // bbox center
      const centers = dets.map(d=>{
        const bb = d.boundingBox;
        return { x: (bb.xMin + bb.width/2) * canvas.width,
                 y: (bb.yMin + bb.height/2) * canvas.height };
      }).sort((a,b)=>a.x-b.x);

      if (centers[0]){ faceL.x=centers[0].x; faceL.y=centers[0].y; faceL.seen=true; }
      if (centers[1]){ faceR.x=centers[1].x; faceR.y=centers[1].y; faceR.seen=true; }

      // auto start kalau 2 wajah sudah ada
      if (!running && faceL.seen && faceR.seen){
        beginRunning();
      }
    });

    // ========= MediaPipe Hands =========
    const hands = new Hands({
      locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });
    hands.setOptions({
      maxNumHands: 2,
      modelComplexity: 0,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    hands.onResults((res)=>{
      h1.seen=false; h2.seen=false;
      const ls = res.multiHandLandmarks || [];
      // ambil index fingertip (8)
      const pts = ls.slice(0,2).map(lm=>{
        const p = lm[8];
        return { x: p.x*canvas.width, y: p.y*canvas.height };
      });

      if (pts[0]){ h1.x=pts[0].x; h1.y=pts[0].y; h1.seen=true; }
      if (pts[1]){ h2.x=pts[1].x; h2.y=pts[1].y; h2.seen=true; }
    });

    // ========= camera =========
    let cam=null;
    async function startCamera(){
      cam = new Camera(video, {
        onFrame: async ()=>{
          // kirim frame ke 2 model
          await fd.send({image: video});
          await hands.send({image: video});
        },
        width: 1280,
        height: 720
      });
      await cam.start();
    }

    // ========= collisions =========
    function tryCatch(ball, hand, who){
      const catchR = ball.r + 28;
      if (!hand.seen) return false;

      if (dist(ball.x, ball.y, hand.x, hand.y) < catchR){
        if (ball.owner === who){
          // benar
          if (who===1){ score1++; s1El.textContent=score1; }
          else { score2++; s2El.textContent=score2; }
        }else{
          // SALAH -> skor berkurang
          if (who===1){
            score1 = Math.max(0, score1-1); s1El.textContent=score1;
            toast2("‚ùå P1 salah nangkap!");
          }else{
            score2 = Math.max(0, score2-1); s2El.textContent=score2;
            toast2("‚ùå P2 salah nangkap!");
          }
          // alert juga (sesuai request)
          alert("Kamu salah nangkap üòÖ");
        }

        // respawn bola owner yg sama biar tetap adil
        Object.assign(ball, spawnBall(ball.owner));
        return true;
      }
      return false;
    }

    // ========= render loop =========
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // mirror view feel (biar kayak selfie)
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);

      // background tint
      ctx.fillStyle="rgba(255,0,90,.10)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // guide center
      ctx.globalAlpha=.25;
      ctx.strokeStyle="#ff4d88";
      ctx.setLineDash([10,10]);
      ctx.beginPath();
      ctx.moveTo(canvas.width/2, 12);
      ctx.lineTo(canvas.width/2, canvas.height-12);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.globalAlpha=1;

      // draw face markers
      const faceRRadius=42;
      if (faceL.seen){
        ctx.lineWidth=6; ctx.strokeStyle="#fff";
        ctx.beginPath(); ctx.arc(faceL.x, faceL.y, faceRRadius, 0, Math.PI*2); ctx.stroke();
      }
      if (faceR.seen){
        ctx.lineWidth=6; ctx.strokeStyle="#ff1f5a";
        ctx.beginPath(); ctx.arc(faceR.x, faceR.y, faceRRadius, 0, Math.PI*2); ctx.stroke();
      }

      // draw hands
      function drawHand(h, color){
        if (!h.seen) return;
        ctx.fillStyle=color;
        ctx.beginPath(); ctx.arc(h.x,h.y,12,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha=.22;
        ctx.beginPath(); ctx.arc(h.x,h.y,28,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha=1;
      }
      drawHand(h1, "#fff");
      drawHand(h2, "#ff1f5a");

      // balls
      for (const b of balls){
        if (running){
          b.x += b.vx; b.y += b.vy;
          if (b.x < b.r || b.x > canvas.width-b.r) b.vx *= -1;
          if (b.y < b.r || b.y > canvas.height-b.r) b.vy *= -1;

          // player side assignment by hand position (kiri/kanan layar)
          // karena mirror, kiri/kanan kebalik -> kita pakai canvas mirrored coords, jadi normal terasa selfie
          // P1 = kiri, P2 = kanan
          if (h1.seen){
            const who = (h1.x < canvas.width/2) ? 1 : 2;
            tryCatch(b, h1, who);
          }
          if (h2.seen){
            const who = (h2.x < canvas.width/2) ? 1 : 2;
            tryCatch(b, h2, who);
          }

          // win
          target = clamp(target, 3, 200);
          if (score1 >= target || score2 >= target){
            running=false;
            overlay.style.display="flex";
            overlay.querySelector("h2").textContent = (score1>=target) ? "üéâ Player 1 menang!" : "üéâ Player 2 menang!";
            overlay.querySelector("p").innerHTML = "Klik <b>Reset</b> untuk main lagi üíó";
          }
        }

        // draw ball
        const fill = (b.owner===1) ? "#fff" : "#ff1f5a";
        const stroke = (b.owner===1) ? "#ff4d88" : "#fff";

        ctx.globalAlpha=.18;
        ctx.fillStyle=fill;
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r+10,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha=1;

        ctx.fillStyle=fill;
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();

        ctx.lineWidth=4;
        ctx.strokeStyle=stroke;
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.stroke();
      }

      ctx.restore(); // end mirror

      requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);

    // ========= UI events =========
    $("exit").onclick = ()=> location.href="book.html";
    $("reset").onclick = ()=> resetGame();

    $("start").onclick = async ()=>{
      target = clamp(parseInt($("target").value||"10",10), 3, 200);
      tLabel.textContent = target;
      resetGame();
      overlay.querySelector("h2").textContent="Mendeteksi 2 wajah‚Ä¶";
      overlay.querySelectorAll("p")[0].textContent="Pastikan berdua terlihat (kiri & kanan).";
      overlay.querySelectorAll("p")[1].textContent="Game mulai otomatis kalau sudah terdeteksi.";

      try{
        await startCamera();
      }catch(e){
        console.error(e);
        overlay.querySelector("h2").textContent="‚ùå Kamera gagal dibuka";
        overlay.querySelectorAll("p")[0].textContent="Cek izin kamera di browser (Allow).";
        overlay.querySelectorAll("p")[1].textContent="Kalau di HP: pastikan pakai HTTPS (Vercel aman).";
      }
    };

    // init
    tLabel.textContent = $("target").value;
    resetGame();
  </script>
</body>
</html>
