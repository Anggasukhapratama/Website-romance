<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>‚ú® Cinta Capture ¬∑ game wajah & tangan ‚ú®</title>

  <!-- Google Font untuk sentuhan lebih manis -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;800;1000&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --love: #ff3b6f;
      --love-glow: #ff8aa7;
      --light: #fff9fb;
      --glass: rgba(255, 240, 245, 0.2);
      --glass-border: rgba(255, 255, 255, 0.3);
      --shadow-pop: 0 20px 40px rgba(255, 20, 100, 0.3);
      --font-main: 'Quicksand', system-ui, -apple-system, sans-serif;
    }

    body, html {
      height: 100%;
      overflow: hidden;
      font-family: var(--font-main);
      background: #110005;  /* fallback */
    }

    #stage {
      position: fixed;
      inset: 0;
      background: #110005;
    }

    /* video dan canvas ‚Äî kamera fullscreen */
    video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);  /* mirror biar natural */
      z-index: 1;
      pointer-events: none;
      filter: brightness(1.02) contrast(1.02) saturate(1.1);
    }

    canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;  /* biar HUD tetap bisa diklik */
      display: block;
    }

    /* HUD glassmorphism + cantik */
    .hudTop {
      position: absolute;
      left: env(safe-area-inset-left, 12px);
      right: env(safe-area-inset-right, 12px);
      top: env(safe-area-inset-top, 16px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      z-index: 10;
      pointer-events: none;
    }

    .hudGroup {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      pointer-events: auto;
      backdrop-filter: blur(8px);
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 6px 10px;
    }

    .chip {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 800;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 25px -5px rgba(255, 40, 100, 0.4);
      letter-spacing: 0.3px;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 20px;
      box-shadow: 0 0 10px currentColor;
    }

    .dot.p1 { background: #ffffff; box-shadow: 0 0 12px #fff; }
    .dot.p2 { background: #ff90b5; box-shadow: 0 0 16px #ff3b6f; }

    .btn {
      background: rgba(255, 220, 235, 0.25);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.35);
      padding: 8px 18px;
      border-radius: 40px;
      font-weight: 1000;
      color: white;
      cursor: pointer;
      transition: 0.25s;
      font-size: 0.9rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .btn:hover {
      background: rgba(255, 120, 160, 0.45);
      transform: translateY(-3px);
      border-color: white;
    }

    /* banner bawah */
    .hudBottom {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: max(env(safe-area-inset-bottom, 16px), 16px);
      width: min(92%, 650px);
      z-index: 10;
      pointer-events: none;
    }

    .banner {
      background: rgba(20, 0, 10, 0.4);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 140, 180, 0.5);
      border-radius: 40px;
      padding: 14px 24px;
      color: white;
      font-weight: 700;
      text-align: center;
      font-size: 1rem;
      box-shadow: 0 20px 30px -5px var(--love);
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.25);
    }

    .banner small {
      display: block;
      margin-top: 6px;
      opacity: 0.9;
      font-weight: 600;
      color: #ffe2ec;
    }

    /* overlay start (romantic) */
    .overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 40%, rgba(255, 100, 150, 0.4), rgba(10, 0, 5, 0.9));
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 20;
    }

    .card {
      max-width: 460px;
      width: 100%;
      background: rgba(255, 240, 245, 0.2);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 200, 220, 0.5);
      border-radius: 40px;
      padding: 28px 20px;
      box-shadow: 0 40px 70px rgba(255, 20, 80, 0.5);
      text-align: center;
      color: white;
    }

    .card .title {
      font-size: 2.1rem;
      font-weight: 1000;
      margin: 8px 0 10px;
      background: linear-gradient(135deg, #ffe7f0, #ffffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px #ff99bb;
    }

    .sub {
      font-weight: 600;
      margin: 16px 0 20px;
      color: #ffeef4;
      line-height: 1.5;
      font-size: 1.05rem;
    }

    .row {
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .input {
      background: rgba(0, 0, 0, 0.3);
      border: 1.5px solid rgba(255, 255, 255, 0.5);
      border-radius: 30px;
      padding: 12px 20px;
      width: 120px;
      color: white;
      font-weight: 800;
      font-size: 1.2rem;
      text-align: center;
      outline: none;
    }

    .input:focus {
      border-color: #ff90b5;
      box-shadow: 0 0 0 4px rgba(255, 120, 160, 0.5);
    }

    .bigBtn {
      background: linear-gradient(145deg, #ff5f8f, #ff2b5c);
      border: none;
      padding: 14px 34px;
      border-radius: 60px;
      font-weight: 1000;
      font-size: 1.3rem;
      color: white;
      box-shadow: 0 15px 30px #ff3366;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .bigBtn:hover {
      transform: scale(1.05);
      background: linear-gradient(145deg, #ff799f, #ff4d7a);
    }

    /* landscape gate */
    .landscapeGate {
      position: absolute;
      inset: 0;
      background: rgba(30, 0, 10, 0.8);
      backdrop-filter: blur(14px);
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      visibility: hidden;
      opacity: 0;
      transition: 0.3s;
    }

    .landscapeGate.show {
      visibility: visible;
      opacity: 1;
    }

    .rotateIcon {
      font-size: 60px;
      filter: drop-shadow(0 0 10px #ffa0c0);
    }

    .toast {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 130px;
      background: rgba(255, 30, 80, 0.9);
      backdrop-filter: blur(16px);
      padding: 14px 28px;
      border-radius: 60px;
      color: white;
      font-weight: 1000;
      font-size: 1.2rem;
      border: 1px solid white;
      box-shadow: 0 10px 30px rgba(255,0,70,0.7);
      z-index: 50;
      display: none;
      white-space: nowrap;
    }

    .toast.show { display: block; }

    /* minor touch */
    #hint {
      background: rgba(255, 230, 240, 0.2);
      border-radius: 60px;
      padding: 12px;
    }
  </style>
</head>
<body>
  <div id="stage">
    <video id="video" playsinline></video>
    <canvas id="c"></canvas>

    <!-- HUD atas super gemay -->
    <div class="hudTop">
      <div class="hudGroup">
        <span class="chip">üéÆ‚ú® Love catcher</span>
        <span class="chip"><span class="dot p1"></span> P1 <span id="s1">0</span></span>
        <span class="chip"><span class="dot p2"></span> P2 <span id="s2">0</span></span>
        <span class="chip">üéØ <span id="tLabel">10</span></span>
      </div>
      <div class="hudGroup">
        <button id="reset" class="btn">‚ü≤ Reset</button>
        <button id="exit" class="btn">üö™ Keluar</button>
      </div>
    </div>

    <div class="hudBottom">
      <div class="banner" id="banner">
        üíó <strong>tangkap bola sesuai warna tanganmu</strong> ‚Äî kiri (putih) punya P1, kanan (pink) punya P2
        <small>‚ö†Ô∏è salah tangkap? skor berkurang üò±  tapi santuy, ini cinta üíã</small>
      </div>
    </div>

    <!-- overlay start -->
    <div id="overlay" class="overlay">
      <div class="card">
        <div class="title">üå∏ main yuk! üå∏</div>
        <p class="sub">
          tunggu sampai <b>2 wajah terdeteksi</b> (kiri/p1, kanan/p2) <br>
          lalu tangkap bola pakai ujung jari telunjuk ‚ú®
        </p>
        <div class="row">
          <label style="font-weight:900;">üèÜ target poin</label>
          <input id="target" class="input" type="number" min="3" max="200" value="10">
          <button id="start" class="bigBtn">mulai ‚ù§Ô∏è</button>
        </div>
        <p class="sub" id="hint" style="margin-top:12px;">
          üåà pastikan cahaya cukup & posisi landscape biar makin seru
        </p>
      </div>
    </div>

    <!-- landscape reminder -->
    <div id="landGate" class="landscapeGate">
      <div class="card" style="max-width:380px;">
        <div class="rotateIcon">üì±‚Ü™Ô∏èüíû</div>
        <div class="title">rotasi ya say</div>
        <p class="sub">mainnya lebih mantap kalo landscape, biar tangan leluasa</p>
        <button id="continueAnyway" class="bigBtn" style="font-size:1.1rem;">lanjut aja (portrait)</button>
      </div>
    </div>

    <!-- toast notif -->
    <div id="toast" class="toast">üíî salah tangkap!</div>
  </div>

  <!-- mediapipe libs -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <script>
    (function() {
      const $ = id => document.getElementById(id);
      const video = $('video');
      const canvas = $('c');
      const ctx = canvas.getContext('2d');

      // elemen UI
      const overlay = $('overlay');
      const landGate = $('landGate');
      const toastEl = $('toast');
      const s1El = $('s1'), s2El = $('s2'), tLabel = $('tLabel');
      const targetInput = $('target');
      const hint = $('hint');

      // helper functions
      const clamp = (v, mn, mx) => Math.max(mn, Math.min(mx, v));
      const dist = (x1,y1,x2,y2) => Math.hypot(x1-x2, y1-y2);
      const showToast = (msg) => {
        toastEl.textContent = msg;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 900);
      };

      // resize canvas sesuai layar
      const resizeCanvas = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      };
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      // landscape detector
      const isLandscape = () => window.innerWidth > window.innerHeight;

      // state game
      let running = false;
      let score1 = 0, score2 = 0;
      let target = 10;

      // detected objects
      const faceL = { x:0, y:0, seen: false };
      const faceR = { x:0, y:0, seen: false };
      const hand1 = { x:0, y:0, seen: false }; // putih
      const hand2 = { x:0, y:0, seen: false }; // pink

      // bola
      let balls = [];
      const BALL_COUNT = 10;

      function spawnBall(owner) { // owner 1 atau 2
        const r = 20 + Math.random() * 16;
        const x = r + Math.random() * (canvas.width - 2*r);
        const y = r + 80 + Math.random() * (canvas.height - 2*r - 120);
        const vx = (Math.random() * 2 - 1) * (2.2 + Math.random() * 2.5);
        const vy = (Math.random() * 2 - 1) * (2.2 + Math.random() * 2.5);
        return { owner, x, y, vx, vy, r };
      }

      function seedBalls() {
        balls = [];
        for (let i = 0; i < BALL_COUNT; i++) {
          balls.push(spawnBall(i % 2 === 0 ? 1 : 2));
        }
      }

      // reset game
      function resetGame() {
        running = false;
        score1 = 0; score2 = 0;
        s1El.textContent = '0';
        s2El.textContent = '0';
        seedBalls();
        overlay.style.display = 'flex';
        hint.innerHTML = 'üåà pastikan cahaya cukup & posisi landscape biar makin seru';
      }

      // mulai running (sembunyikan overlay)
      function beginRunning() {
        running = true;
        overlay.style.display = 'none';
      }

      // mediapipe face detection
      const faceDetect = new FaceDetection({
        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${f}`
      });
      faceDetect.setOptions({ model: 'short', minDetectionConfidence: 0.6 });
      faceDetect.onResults(results => {
        faceL.seen = false;
        faceR.seen = false;
        const dets = results.detections || [];
        if (dets.length === 0) return;

        const centers = dets.slice(0,2).map(d => {
          const bb = d.boundingBox;
          return {
            x: (bb.xMin + bb.width/2) * canvas.width,
            y: (bb.yMin + bb.height/2) * canvas.height
          };
        }).sort((a,b) => a.x - b.x);

        if (centers[0]) { faceL.x = centers[0].x; faceL.y = centers[0].y; faceL.seen = true; }
        if (centers[1]) { faceR.x = centers[1].x; faceR.y = centers[1].y; faceR.seen = true; }

        // auto start kalau dua wajah terdeteksi
        if (!running && faceL.seen && faceR.seen) {
          beginRunning();
        }
      });

      // hands detection
      const hands = new Hands({
        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
      });
      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 0,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
      });
      hands.onResults(results => {
        hand1.seen = false;
        hand2.seen = false;
        const landmarks = results.multiHandLandmarks || [];
        if (landmarks.length === 0) return;

        // ambil ujung jari telunjuk (index 8)
        const pts = landmarks.slice(0,2).map(lm => ({
          x: lm[8].x * canvas.width,
          y: lm[8].y * canvas.height
        }));

        if (pts[0]) { hand1.x = pts[0].x; hand1.y = pts[0].y; hand1.seen = true; }
        if (pts[1]) { hand2.x = pts[1].x; hand2.y = pts[1].y; hand2.seen = true; }
      });

      // kamera
      let camera = null;
      async function startCamera() {
        camera = new Camera(video, {
          onFrame: async () => {
            await faceDetect.send({ image: video });
            await hands.send({ image: video });
          },
          width: 1280,
          height: 720
        });
        await camera.start();
      }

      // logika side berdasarkan posisi tangan (kiri layar = P1)
      function whoFromHand(handX) {
        return handX < canvas.width / 2 ? 1 : 2;
      }

      function penalize(who) {
        if (who === 1) {
          score1 = Math.max(0, score1 - 1);
          s1El.textContent = score1;
          showToast('‚ùå P1 salah tangkap!');
        } else {
          score2 = Math.max(0, score2 - 1);
          s2El.textContent = score2;
          showToast('‚ùå P2 salah tangkap!');
        }
      }

      function reward(who) {
        if (who === 1) { score1++; s1El.textContent = score1; }
        else { score2++; s2El.textContent = score2; }
      }

      function tryCatch(ball, hand, who) {
        if (!hand.seen) return false;
        const catchDist = ball.r + 30;
        if (dist(ball.x, ball.y, hand.x, hand.y) < catchDist) {
          if (ball.owner === who) reward(who);
          else penalize(who);
          // ganti bola baru (owner tetap sesuai awal biar adil)
          const newBall = spawnBall(ball.owner);
          ball.x = newBall.x; ball.y = newBall.y;
          ball.vx = newBall.vx; ball.vy = newBall.vy;
          ball.r = newBall.r;
          return true;
        }
        return false;
      }

      // render utama
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // karena video di belakang (z-index lebih rendah), kita hanya gambar overlay deteksi
        // canvas transparan agar video terlihat

        // gambar garis tengah
        ctx.save();
        ctx.strokeStyle = '#ffb0c3';
        ctx.lineWidth = 2;
        ctx.setLineDash([12, 16]);
        ctx.beginPath();
        ctx.moveTo(canvas.width/2, 30);
        ctx.lineTo(canvas.width/2, canvas.height-30);
        ctx.stroke();
        ctx.setLineDash([]);

        // gambar lingkaran wajah (mirror effect)
        if (faceL.seen) {
          ctx.beginPath();
          ctx.arc(faceL.x, faceL.y, 45, 0, 2*Math.PI);
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 5;
          ctx.stroke();
          ctx.shadowColor = '#fff';
          ctx.shadowBlur = 20;
          ctx.stroke();
          ctx.shadowBlur = 0;
        }
        if (faceR.seen) {
          ctx.beginPath();
          ctx.arc(faceR.x, faceR.y, 45, 0, 2*Math.PI);
          ctx.strokeStyle = '#ff80a5';
          ctx.lineWidth = 5;
          ctx.stroke();
          ctx.shadowColor = '#ff5982';
          ctx.shadowBlur = 20;
          ctx.stroke();
          ctx.shadowBlur = 0;
        }

        // gambar tangan (glowing)
        const drawHand = (h, color) => {
          if (!h.seen) return;
          ctx.shadowColor = color;
          ctx.shadowBlur = 30;
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(h.x, h.y, 18, 0, 2*Math.PI);
          ctx.fill();
          ctx.shadowBlur = 0;
          ctx.shadowColor = 'transparent';
          ctx.globalAlpha = 0.3;
          ctx.beginPath();
          ctx.arc(h.x, h.y, 36, 0, 2*Math.PI);
          ctx.fillStyle = color;
          ctx.fill();
          ctx.globalAlpha = 1.0;
        };
        drawHand(hand1, '#ffffff');
        drawHand(hand2, '#ff9cbc');

        // update & gambar bola
        if (running) {
          for (let b of balls) {
            b.x += b.vx;
            b.y += b.vy;
            if (b.x < b.r) { b.x = b.r; b.vx *= -1; }
            if (b.x > canvas.width - b.r) { b.x = canvas.width - b.r; b.vx *= -1; }
            if (b.y < b.r) { b.y = b.r; b.vy *= -1; }
            if (b.y > canvas.height - b.r) { b.y = canvas.height - b.r; b.vy *= -1; }

            // tangkap dengan kedua tangan
            if (hand1.seen) tryCatch(b, hand1, whoFromHand(hand1.x));
            if (hand2.seen) tryCatch(b, hand2, whoFromHand(hand2.x));
          }

          // cek menang
          if (score1 >= target || score2 >= target) {
            running = false;
            overlay.style.display = 'flex';
            const winner = score1 >= target ? 'P1' : 'P2';
            hint.innerHTML = `üéâ <b>${winner} MENANG!</b> klik reset buat main lagi üíï`;
          }
        }

        // gambar bola2
        for (let b of balls) {
          const grad = ctx.createRadialGradient(b.x-5, b.y-5, 5, b.x, b.y, b.r+10);
          if (b.owner === 1) {
            grad.addColorStop(0, '#fff0f5');
            grad.addColorStop(1, '#ffc0cb');
          } else {
            grad.addColorStop(0, '#ffb3c6');
            grad.addColorStop(1, '#ff5f8f');
          }
          ctx.shadowColor = b.owner === 1 ? '#ffe2ec' : '#ff2b67';
          ctx.shadowBlur = 30;
          ctx.beginPath();
          ctx.arc(b.x, b.y, b.r, 0, 2*Math.PI);
          ctx.fillStyle = grad;
          ctx.fill();
          ctx.shadowBlur = 0;
          // stroke border
          ctx.strokeStyle = b.owner === 1 ? '#ffffff' : '#ffd0df';
          ctx.lineWidth = 4;
          ctx.stroke();
        }
        ctx.restore();

        requestAnimationFrame(draw);
      }
      draw();

      // landscape gate logic
      let allowPortrait = false;
      function updateGate() {
        if (allowPortrait) { landGate.classList.remove('show'); return; }
        if (!isLandscape()) landGate.classList.add('show');
        else landGate.classList.remove('show');
      }
      window.addEventListener('resize', updateGate);
      $('continueAnyway').onclick = () => { allowPortrait = true; landGate.classList.remove('show'); };

      // UI events
      $('exit').onclick = () => location.href = 'about:blank';  // biar aman ganti dummy
      $('reset').onclick = () => resetGame();

      $('start').onclick = async () => {
        target = clamp(parseInt(targetInput.value, 10) || 10, 3, 200);
        tLabel.textContent = target;

        // fullscreen jika bisa
        try { await document.documentElement.requestFullscreen(); } catch(e) {}

        allowPortrait = false;
        updateGate();

        resetGame();  // overlay muncul lagi, tapi nanti hilang sendiri saat 2 face
        hint.innerHTML = 'üëÄ mendeteksi 2 wajah... (kiri P1, kanan P2)';

        try {
          seedBalls();
          await startCamera();
        } catch (e) {
          hint.innerHTML = '‚ùå kamera error. izinkan kamera dan pakai https (vercel aman)';
        }
      };

      // initial
      tLabel.textContent = targetInput.value;
      seedBalls();
      resetGame();

    })();
  </script>
</body>
</html>